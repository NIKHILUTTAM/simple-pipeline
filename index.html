name: Auto-Healing Pipeline

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch: {}

env:
  SITE_URL: "https://simple-pipeline.vercel.app"
  RETRIES: 3
  RETRY_SLEEP: 8

jobs:

  health-check:
    runs-on: ubuntu-latest
    outputs:
      trigger_deploy: ${{ steps.result.outputs.trigger_deploy }}
    steps:
      - id: result
        run: |
          echo "Event: $GITHUB_EVENT_NAME"

          # If push → skip health logic (deploy will run anyway)
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            echo "trigger_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Scheduled → perform health check
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")
          echo "http_code=$CODE"

          if [ "$CODE" = "200" ]; then
            echo "trigger_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "trigger_deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: health-check
    if: ${{ github.event_name == 'push' || needs.health-check.outputs.trigger_deploy == 'true' }}
    outputs:
      vercel_exit_code: ${{ steps.deploy_step.outputs.vercel_exit_code }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - id: deploy_step
        name: Deploy to Vercel (with retries)
        run: |
          set +e
          attempt=1
          > deploy_output.txt

          while [ $attempt -le $RETRIES ]; do
            OUTPUT=$(vercel --prod --confirm --token "${{ secrets.VERCEL_TOKEN }}" 2>&1)
            EXIT=$?

            echo "Attempt $attempt exit: $EXIT" >> deploy_output.txt
            echo "$OUTPUT" >> deploy_output.txt

            if [ $EXIT -eq 0 ]; then
              echo "vercel_exit_code=0" >> $GITHUB_OUTPUT
              exit 0
            fi

            sleep $RETRY_SLEEP
            attempt=$((attempt+1))
          done

          echo "vercel_exit_code=$EXIT" >> $GITHUB_OUTPUT
          exit 0

      - name: Upload deploy log
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy_output.txt

  autoheal:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.vercel_exit_code != '0'
    steps:
      - uses: actions/checkout@v4

      - name: Record Heal Log
        run: |
          echo "Auto-heal triggered at $(date)" > heal.log
          echo "Exit code: ${{ needs.deploy.outputs.vercel_exit_code }}" >> heal.log

      - name: Update README
        run: |
          cat <<EOF > README.md
# ⚠️ Auto-Heal Triggered

A deployment failure was detected.

- Time: $(date)
- Site: $SITE_URL

This was auto-generated by GitHub Actions.
EOF

      - name: Commit Heal Changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add README.md heal.log || true
          git commit -m "Auto-Heal: Deployment failed" || true
          git push || true

      - name: Upload Heal Log
        uses: actions/upload-artifact@v4
        with:
          name: heal-log
          path: heal.log
