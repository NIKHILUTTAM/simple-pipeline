name: Site Health Monitor & Auto-Heal

# Runs every 5 minutes. Adjust cron as needed.
on:
  schedule:
    - cron:  "*/5 * * * *"
  workflow_dispatch: {}

env:
  SITE_URL: "https://simple-pipeline.vercel.app"
  RETRIES: 3
  RETRY_SLEEP: 8

jobs:
  health-check:
    runs-on: ubuntu-latest
    outputs:
      healthy: ${{ steps.check.outputs.healthy }}

    steps:
      - name: Health check - GET
        id: check
        run: |
          set -euo pipefail
          echo "Checking ${SITE_URL} ..."
          # timeout 10s; write http code to variable
          CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE_URL}" || echo "000")
          echo "http_code=$CODE"
          if [ "$CODE" = "200" ]; then
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi

  autoheal:
    needs: health-check
    if: needs.health-check.outputs.healthy == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for possible README commit)
        uses: actions/checkout@v4

      - name: Show context
        run: |
          echo "Health check failed for ${SITE_URL} at $(date)"
          echo "Will attempt auto-heal with ${RETRIES} retries."

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Attempt redeploys (retries)
        id: redeploy
        run: |
          set -euo pipefail
          attempt=1
          success=0
          while [ $attempt -le ${RETRIES} ]; do
            echo "Attempt #$attempt: running vercel deploy (non-interactive)..."
            # Deploy and capture output
            OUT=$(vercel --prod --confirm --token "${{ secrets.VERCEL_TOKEN }}" 2>&1) || true
            CODE=$?
            echo "VERCEL_EXIT_CODE=$CODE" >> redeploy_output.txt
            printf "%s\n" "$OUT" >> redeploy_output.txt
            if [ "$CODE" -eq 0 ]; then
              echo "success=true" >> $GITHUB_OUTPUT
              success=1
              break
            else
              echo "deploy returned code $CODE; sleeping ${RETRY_SLEEP}s before next try"
              sleep ${RETRY_SLEEP}
            fi
            attempt=$((attempt+1))
          done

          if [ $success -eq 0 ]; then
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Upload redeploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: redeploy-log
          path: redeploy_output.txt

      - name: Check redeploy result and set summary
        run: |
          grep -q "success=true" <(echo "${{ steps.redeploy.outputs.success || ''}") || true
          # If success was set to true, print message (we also check redeploy_output)
          if grep -q "success=true" redeploy_output.txt 2>/dev/null || [ "${{ steps.redeploy.outcome }}" = "success" ]; then
            echo "Redeploy successful."
            exit 0
          else
            echo "Redeploy attempts failed - performing fallback auto-heal actions."
          fi

      - name: Auto-heal fallback: Update README and record heal.log
        run: |
          echo "# ðŸŒ¦ï¸ Auto-Heal: Emergency Recovery" > README.md
          echo "" >> README.md
          echo "A site outage was detected at $(date)." >> README.md
          echo "Auto-heal attempted ${RETRIES} redeploy(s) and failed; actions recorded in heal.log." >> README.md
          echo "" >> README.md
          echo "This file was updated automatically by the monitor workflow." >> README.md

          echo "Autoheal run at: $(date)" > heal.log
          echo "Site: ${SITE_URL}" >> heal.log
          echo "Reason: Health check failed and redeploy retry attempts exhausted." >> heal.log
          echo "See redeploy-log artifact for details." >> heal.log

      - name: Commit README and heal.log (best-effort)
        env:
          GIT_AUTHOR_NAME: "github-actions"
          GIT_AUTHOR_EMAIL: "github-actions@github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add README.md heal.log || true
          git commit -m "Auto-Heal: emergency recovery performed at $(date)" || echo "Nothing to commit"
          git push || echo "Push failed (no permission). Changes still local."

      - name: Create GitHub issue (optional notification)
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Auto-Heal performed: site down (${{ env.SITE_URL }})"
          file: ./heal.log
          labels: "auto-heal, incident"
          assignees: ""

      - name: Upload heal.log artifact
        uses: actions/upload-artifact@v4
        with:
          name: heal-log
          path: heal.log
