name: Auto-Healing Pipeline

on:
  push:
    branches: [ "main" ]
  schedule:
    # Runs every 30 mins to check health
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

env:
  SITE_URL: "https://simple-pipeline.vercel.app"
  RETRIES: 2
  RETRY_SLEEP: 5

# ðŸ”‘ CRITICAL: This gives the bot permission to write to your repo
permissions:
  contents: write
  issues: write

jobs:
  # 1. NEW JOB: The File Police
  integrity-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Needed to access git history for restoration

      - name: ðŸ§  Smart Restore from History
        id: check_files
        run: |
          # 1. Check if index.html is missing
          if [ ! -f "index.html" ]; then
            echo "ðŸš¨ CRITICAL: index.html is MISSING!"
            echo "ðŸ”™ Option 4: Restoring from Git History (Last Safe Commit)..."
            
            # 2. Restore the file from the previous commit (HEAD~1)
            # This guarantees we get the correct content, even if the file was deleted entirely.
            git checkout HEAD~1 -- index.html
            
            if [ -f "index.html" ]; then
              echo "âœ… index.html restored successfully."
              echo "fixed=true" >> $GITHUB_OUTPUT
              
              # 3. Cleanup: Find the bad renamed file (the culprit) to delete it
              # We verify it's not a safe file before marking it as garbage
              CULPRIT=$(ls | grep -v -E "^(index.html|style.css|README.md|heal.log|package.json|package-lock.json|vercel.json|node_modules|\.github|\.git)$" | head -n 1)
              
              if [ -n "$CULPRIT" ]; then
                echo "ðŸ§¹ Detected abandoned file '$CULPRIT'. Marking for deletion."
                echo "garbage_file=$CULPRIT" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ Failed to restore from history. File might not have existed in previous commit."
              echo "fixed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… index.html is present. No action needed."
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push the Fix
        if: steps.check_files.outputs.fixed == 'true'
        run: |
          git config user.name "File Police Bot"
          git config user.email "bot@github.com"
          
          # Stage the restored file
          git add index.html
          
          # If we found a garbage file (the renamed one), remove it
          if [ -n "${{ steps.check_files.outputs.garbage_file }}" ]; then
            git rm "${{ steps.check_files.outputs.garbage_file }}"
            MSG="ðŸš‘ Auto-Healed: Restored index.html & removed ${{ steps.check_files.outputs.garbage_file }}"
          else
            MSG="ðŸš‘ Auto-Healed: Restored index.html from history"
          fi
          
          git commit -m "$MSG" || echo "Nothing to commit"
          git push

  # 2. Check if the site is alive
  health-check:
    runs-on: ubuntu-latest
    needs: integrity-check  # Wait for integrity check to finish first
    outputs:
      trigger_deploy: ${{ steps.decide.outputs.trigger_deploy }}
    steps:
      - name: Check Status
        id: decide
        run: |
          # If this is a Push event, we ALWAYS want to deploy.
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "trigger_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If Scheduled/Manual, check the website status code
          echo "Checking ${SITE_URL}..."
          CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE_URL}" || echo "000")
          echo "HTTP Response: $CODE"
          
          if [ "$CODE" = "200" ]; then
            echo "âœ… Site is Healthy. No deploy needed."
            echo "trigger_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Site is DOWN ($CODE). Triggering Deploy."
            echo "trigger_deploy=true" >> $GITHUB_OUTPUT
          fi

  # 3. Deploy to Vercel (Only runs if needed)
  deploy:
    runs-on: ubuntu-latest
    needs: [integrity-check, health-check]
    # Run if it's a Push OR if Health Check said "true"
    if: ${{ github.event_name == 'push' || needs.health-check.outputs.trigger_deploy == 'true' }}
    outputs:
      vercel_exit_code: ${{ steps.deploy_step.outputs.vercel_exit_code }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - id: deploy_step
        name: Deploy to Vercel (Safe Mode)
        shell: bash
        run: |
          # We turn off immediate exit on error so we can capture the code
          set +e 
          
          # Attempt Deployment
          echo "ðŸš€ Starting Deployment..."
          OUTPUT=$(vercel --prod --confirm --token "${{ secrets.VERCEL_TOKEN }}" 2>&1)
          CODE=$?
          
          echo "Vercel Exit Code: $CODE"
          
          # Save the exit code to outputs for the next job
          echo "vercel_exit_code=$CODE" >> $GITHUB_OUTPUT
          
          # If success, we are done
          if [ "$CODE" -eq 0 ]; then
            echo "âœ… Deployment Successful!"
            exit 0
          else
            echo "âŒ Deployment Failed!"
            # We exit 0 here to keep the pipeline 'Green' so the autoheal job can run
            exit 0 
          fi

  # 4. Auto-Heal (Only runs if Deploy Failed)
  autoheal:
    needs: deploy
    runs-on: ubuntu-latest
    # Check if the previous job output a non-zero exit code
    if: ${{ needs.deploy.outputs.vercel_exit_code != '0' && needs.deploy.outputs.vercel_exit_code != '' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ðŸš‘ Apply Auto-Healing
        run: |
          echo "Detected Deployment Failure. activating Auto-Heal protocols..."
          
          # Update README without using fragile EOF blocks
          echo "# âš ï¸ Auto-Heal Triggered" > README.md
          echo "" >> README.md
          echo "The pipeline detected a deployment failure on $(date)." >> README.md
          echo "System attempted to recover automatically." >> README.md
          
          # Log details
          echo "Auto-heal triggered at: $(date)" > heal.log
          echo "Vercel failed to deploy." >> heal.log

      - name: Commit and Push Changes
        run: |
          git config user.name "Auto-Heal Bot"
          git config user.email "bot@github.com"
          git add README.md heal.log
          git commit -m "ðŸš‘ Auto-Heal: Reported deployment failure"
          git push