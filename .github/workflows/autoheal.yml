name: Auto-Healing Pipeline

on:
  push:
    branches: [ "main" ]
  schedule:
    # Runs every 30 mins to check health
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

env:
  SITE_URL: "https://simple-pipeline.vercel.app"
  RETRIES: 2
  RETRY_SLEEP: 5

# ðŸ”‘ CRITICAL: This gives the bot permission to write to your repo
permissions:
  contents: write
  issues: write

jobs:
  # 1. NEW JOB: The File Police
  integrity-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ•µï¸ Check for 'index.bal' sabotage
        id: check_files
        run: |
          # Check if index.html is missing BUT index.bal exists
          if [ ! -f "index.html" ] && [ -f "index.bal" ]; then
            echo "ðŸš¨ DETECTED ILLEGAL FILE NAME: index.bal"
            echo "ðŸ”§ Initiating auto-correction protocol..."
            
            # THE FIX: Rename it back
            mv index.bal index.html
            
            echo "âœ… File restored to index.html"
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… File structure looks normal."
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push the Fix
        if: steps.check_files.outputs.fixed == 'true'
        run: |
          git config user.name "File Police Bot"
          git config user.email "bot@github.com"
          git add index.html index.bal
          git commit -m "ðŸš‘ Auto-Healed: Renamed index.bal back to index.html"
          git push

  # 2. Check if the site is alive
  health-check:
    runs-on: ubuntu-latest
    needs: integrity-check  # Wait for integrity check to finish first
    outputs:
      trigger_deploy: ${{ steps.decide.outputs.trigger_deploy }}
    steps:
      - name: Check Status
        id: decide
        run: |
          # If this is a Push event, we ALWAYS want to deploy.
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "trigger_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If Scheduled/Manual, check the website status code
          echo "Checking ${SITE_URL}..."
          CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE_URL}" || echo "000")
          echo "HTTP Response: $CODE"
          
          if [ "$CODE" = "200" ]; then
            echo "âœ… Site is Healthy. No deploy needed."
            echo "trigger_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Site is DOWN ($CODE). Triggering Deploy."
            echo "trigger_deploy=true" >> $GITHUB_OUTPUT
          fi

  # 3. Deploy to Vercel (Only runs if needed)
  deploy:
    runs-on: ubuntu-latest
    needs: [integrity-check, health-check]
    # Run if it's a Push OR if Health Check said "true"
    if: ${{ github.event_name == 'push' || needs.health-check.outputs.trigger_deploy == 'true' }}
    outputs:
      vercel_exit_code: ${{ steps.deploy_step.outputs.vercel_exit_code }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - id: deploy_step
        name: Deploy to Vercel (Safe Mode)
        shell: bash
        run: |
          # We turn off immediate exit on error so we can capture the code
          set +e 
          
          # Attempt Deployment
          echo "ðŸš€ Starting Deployment..."
          OUTPUT=$(vercel --prod --confirm --token "${{ secrets.VERCEL_TOKEN }}" 2>&1)
          CODE=$?
          
          echo "Vercel Exit Code: $CODE"
          
          # Save the exit code to outputs for the next job
          echo "vercel_exit_code=$CODE" >> $GITHUB_OUTPUT
          
          # If success, we are done
          if [ "$CODE" -eq 0 ]; then
            echo "âœ… Deployment Successful!"
            exit 0
          else
            echo "âŒ Deployment Failed!"
            # We exit 0 here to keep the pipeline 'Green' so the autoheal job can run
            exit 0 
          fi

  # 4. Auto-Heal (Only runs if Deploy Failed)
  autoheal:
    needs: deploy
    runs-on: ubuntu-latest
    # Check if the previous job output a non-zero exit code
    if: ${{ needs.deploy.outputs.vercel_exit_code != '0' && needs.deploy.outputs.vercel_exit_code != '' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ðŸš‘ Apply Auto-Healing
        run: |
          echo "Detected Deployment Failure. activating Auto-Heal protocols..."
          
          # Update README without using fragile EOF blocks
          echo "# âš ï¸ Auto-Heal Triggered" > README.md
          echo "" >> README.md
          echo "The pipeline detected a deployment failure on $(date)." >> README.md
          echo "System attempted to recover automatically." >> README.md
          
          # Log details
          echo "Auto-heal triggered at: $(date)" > heal.log
          echo "Vercel failed to deploy." >> heal.log

      - name: Commit and Push Changes
        run: |
          git config user.name "Auto-Heal Bot"
          git config user.email "bot@github.com"
          git add README.md heal.log
          git commit -m "ðŸš‘ Auto-Heal: Reported deployment failure"
          git push