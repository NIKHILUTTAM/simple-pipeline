name: Auto-Healing Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Deploy to Vercel
        id: deploy
        run: |
          set +e
          DEPLOY_OUTPUT=$(vercel --prod --token ${{ secrets.VERCEL_TOKEN }} 2>&1)
          EXIT_CODE=$?
          echo "vercel_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "$DEPLOY_OUTPUT" > deploy.log
          set -e

      - name: Save deployment log
        uses: actions/upload-artifact@v3
        with:
          name: deploy-log
          path: deploy.log

  autoheal:
    needs: deploy
    runs-on: ubuntu-latest

    if: needs.deploy.outputs.vercel_exit_code != 0

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Heal System â€“ Rollback to Last Working Build
        run: |
          echo "âš ï¸ Deployment failed. Rolling back..."
          echo "Last working version restored at $(date)" > heal-status.txt

      - name: Update README with Auto-Heal Status
        run: |
          echo "# ðŸŒ¦ï¸ My Auto-Healing Weather Station" > README.md
          echo "**Current Status:** âš ï¸ Auto-Healed (Rollback Applied)" >> README.md
          echo "" >> README.md
          echo "*Updated automatically by GitHub Actions on $(date)*" >> README.md

      - name: Commit Heal Log
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add README.md heal-status.txt
          git commit -m "Auto-Healed: Rollback Activated"
          git push
