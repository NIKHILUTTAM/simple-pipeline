name: Auto-Healing Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    outputs:
      vercel_exit_code: ${{ steps.deploy_step.outputs.code }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - id: deploy_step
        name: Deploy to Vercel
        run: |
          set +e
          OUTPUT=$(vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" --confirm 2>&1)
          CODE=$?
          echo "$OUTPUT" > deploy.log
          echo "code=$CODE" >> $GITHUB_OUTPUT
          set -e

      - name: Upload Deploy Log
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy.log

  autoheal:
    needs: deploy
    runs-on: ubuntu-latest
    if: needs.deploy.outputs.vercel_exit_code != '0'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Write Heal Log
        run: echo "Autoheal triggered on $(date)" > heal.log

      - name: Update README
        run: |
          cat > README.md <<EOF
# Auto-Healing Pipeline  
Deployment failed. Autoheal executed successfully.

Time: $(date)
EOF

      - name: Commit Repairs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md heal.log
          git commit -m "Autoheal triggered"
          git push

      - name: Upload Heal Log
        uses: actions/upload-artifact@v4
        with:
          name: heal-log
          path: heal.log
